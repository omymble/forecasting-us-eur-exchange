---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


```{r}
library(readxl)
library(lmtest) 
library(forecast)
library(DIMORA)
library(fpp2)
library(ggplot2)
library(plotly)
library(tseries)
library(randomForest)
library(BASS)
library(Metrics) 
library(dplyr)
library(tibble)
library(TTR)
library(gam)
library(tsibble)
library(fable)
library(feasts)
library(mgcv)
library(xgboost)
```


```{r}
# folder_path = "~/Desktop/unipd/time-series/project/data/"
folder_path = "./data/"

# shares_file <- paste0(folder_path, "us-total-share-prices.csv")
# m2_file <- paste0(folder_path, "us-M2.csv")
# usir_file <- paste0(folder_path, "us-interest-rate.csv")
#ceuir_file <- paste0(folder_path, "eu-interest-rate.csv")
# uscpi_file <- paste0(folder_path, "us-consumer-price-index.csv")
# eucpi_file <- paste0(folder_path, "eu-consumer-price-index.csv")
# rate_file <- paste0(folder_path, "euro-daily-hist_1999_2022.csv")
data_file <- paste0(folder_path, "cleaned_data_without_scale.csv")

# shares<- read.csv(shares_file)
# usm2 <- read.csv(m2_file)
# usir <- read.csv(usir_file)
# euir <- read.csv(euir_file)
# uscpi <- read.csv(uscpi_file)
# eucpi <- read.csv(eucpi_file)
# rate <- read.csv(rate_file)
data <- read.csv(data_file)
```

```{r}
head(data)
```

```{r}
data$DATE <- as.Date(data$DATE)
data_df <- data.frame(date = data$DATE, cpius = data$CPIUS, cpieu = data$CPIEU, m2us = data$M2US, m2eu = data$M2EU, ireu = data$IREU, irus = data$IRUS)
```

```{r}
stl_result <- stl(ts(data_df$ireu, frequency = 12), s.window = 44)
plot(stl_result)

```


```{r}
```


```{r}
```

```{r}
data_ts <- data_df %>%
  mutate(YearMonth = yearmonth(date)) %>%
  select(-date) |>
  as_tsibble(key = NULL,
             index = YearMonth)
```

```{r}
print(data_ts)
```

IR: EU and US
```{r}
ir_eu_us_train <- train_data %>%
  select(ireu, irus, YearMonth) %>%
  as_tsibble()

ir_eu_us_test <- test_data %>%
  select(ireu, irus, YearMonth) %>%
  as_tsibble()

```


```{r}
ir_eu_us_train
```
```{r}
ir_eu_us <- data_ts %>%
  select(ireu, irus, YearMonth) %>%
  as_tsibble()
```


```{r}
ggplot(ir_eu_us, aes(x = YearMonth)) +
  geom_line(aes(y = ireu, color = "Europe")) +
  geom_line(aes(y = irus, color = "US")) +
  labs(title = "Interest Rates in Europe and US over Time",
       x = "Year-Month",
       y = "Interest Rate",
       color = "Country") +
  scale_color_manual(values = c("Europe" = "blue", "US" = "red")) +
  theme_minimal()

```
```{r}
linear_corr <- cor(ir_eu_us$ireu, ir_eu_us$irus, method = "pearson")
corr_test <- rcorr(as.matrix(ir_eu_us[c("ireu", "irus")]), type = "pearson")
p_value <- corr_test$P[1, 2]

cat("Linear Correlation:", linear_corr, "\n")
cat("Significance (p-value):", p_value, "\n")
```


```{r}
nonlinear_corr <- cor(ir_eu_us$ireu, ir_eu_us$irus, method = "spearman")
nonlinear_corr_test <- rcorr(as.matrix(ir_eu_us[c("ireu", "irus")]), type = "spearman")
nonlinear_p_value <- nonlinear_corr_test$P[1, 2]

cat("Non-linear (Spearman) Correlation:", nonlinear_corr, "\n")
cat("Significance (p-value):", nonlinear_p_value, "\n")
```

```{r}
auto.arima(ir_eu_us$ireu)
auto.arima(ir_eu_us$irus)
```

ARIMAX: IR AE and US
```{r}
ir_eu_us_train$YearMonth <- as.Date(paste(ir_eu_us_train$YearMonth, "01"), format = "%Y %b %d")
ir_eu_us_test$YearMonth <- as.Date(paste(ir_eu_us_test$YearMonth, "01"), format = "%Y %b %d")
```


```{r}
predictions <- list()
order_params <- list()

for (p in 1:3) {
  for (d in 0:1) {
    for (q in 1:3) {
      arima_model <- Arima(ir_eu_us_train$ireu, order = c(p, d, q), xreg = ir_eu_us_train$irus)
      order_params[[length(order_params) + 1]] <- c(p, d, q)
      forecast_values <- forecast(arima_model, xreg = ir_eu_us_test$irus)
      predictions[[length(predictions) + 1]] <- forecast_values$mean
    }
  }
}

```


```{r}
best_model_index <- which.min(sapply(predictions, function(pred) accuracy(pred, test_data$ireu)[, "RMSE"]))
```


```{r}
best_model <- predictions[[best_model_index]]
best_order <- order_params[[best_model_index]]
```
```{r}
best_order
```
```{r}
ir_eu_us_test$YearMonth
```




```{r}
best_order <- c(3, 0, 2)  
best_model <- Arima(ir_eu_us_train$ireu, order = best_order, xreg = ir_eu_us_train$irus)

forecast_values <- forecast(best_model, xreg = test_data$irus)

# Plotting the real values, fitted values, and predicted values
plot(ir_eu_us$YearMonth, ir_eu_us$ireu, type = "l", col = "blue", 
     xlab = "Year-Month", ylab = "ireu", main = "ARIMAX Prediction for ireu based on irus")
lines(ir_eu_us_test$YearMonth, forecast_values$mean, col = "red") 
lines(ir_eu_us_train$YearMonth, fitted(best_model), col = "green") 
lines(ir_eu_us_test$YearMonth, ir_eu_us_test$ireu, col = "blue", lty = 2)  # Real test values

legend("topleft", legend = c("Real", "Predicted", "Fitted"), col = c("blue", "red", "green"), lty = 1)
```


```{r}
```


```{r}
```

```{r}
plot(test_data$YearMonth, ir_eu_us_test$ireu, type = "l", col = "blue", 
     xlab = "Year-Month", ylab = "ireu", main = "ARIMAX Prediction for ireu based on irus")
lines(ir_eu_us_test$YearMonth, best_model, col = "red")
legend("topleft", legend = c("Actual", "Predicted"), col = c("blue", "red"), lty = 1)
```


```{r}
```


```{r}
```

```{r}
forecast_values <- forecast(best_model, xreg = ir_eu_us_test$irus)

```

```{r}
plot(ir_eu_us_test$YearMonth, ir_eu_us_test$ireu, type = "l", col = "blue", 
     xlab = "Year-Month", ylab = "ireu", main = "ARIMAX Prediction for IR EU based on IR US")
lines(ir_eu_us_test$YearMonth, best_model, col = "red")
lines(ir_eu_us_test$YearMonth, best_model, col = "green")  # Fitted values
legend("topleft", legend = c("Actual", "Predicted"), col = c("blue", "red"), lty = 1)
```


```{r}
```

------------------------------
```{r}
clipr::write_clip(data_ts) 
```

```{r}
summary(data_ts$cpieu)
```

```{r}
autoplot(data_ts, cpieu) +
  labs(title = "Consumer Price Index for EU",
       y = "CPI")
```


```{r}
summary(data_ts$ireu)
```


```{r}
autoplot(data_ts, ireu) +
  labs(title = "Interest Rate for EU",
       y = "IR")
```
```{r}
print(cor(data_ts$ireu, data_ts$cpieu))
data_ts %>%
  ggplot(aes(x = ireu, y = cpieu)) +
  geom_point() +
  labs(x = "IR EU",
       y = "CPI EU")
```
```{r}
print(cor(data_ts$ireu, data_ts$m2eu))
data_ts %>%
  ggplot(aes(x = ireu, y = m2eu)) +
  geom_point() +
  labs(x = "IR EU",
       y = "M2 EU")
```


```{r}
print(cor(data_ts$cpieu, data_ts$m2eu))
data_ts %>%
  ggplot(aes(x = cpieu, y = m2eu)) +
  geom_point() +
  labs(x = "CPI EU",
       y = "M2 EU")
```


```{r}
```


```{r}
print(cor(data_ts$ireu, data_ts$irus))
data_ts %>%
  ggplot(aes(x = ireu, y = irus)) +
  geom_point() +
  labs(x = "IR EU",
       y = "IR US")
```


```{r}
print(cor(data_ts$cpieu, data_ts$cpius))
data_ts %>%
  ggplot(aes(x = cpieu, y = cpius)) +
  geom_point() +
  labs(x = "CPI EU",
       y = "CPI US")
```


```{r}
print(cor(data_ts$m2eu, data_ts$m2us))
data_ts %>%
  ggplot(aes(x = m2eu, y = m2us)) +
  geom_point() +
  labs(x = "M2 EU",
       y = "M2 US")
```


```{r}

```


```{r}
acf_values <- acf(data_ts$cpieu, plot = FALSE) 
autoplot(acf_values, xlab = "Lag", ylab = "ACF", main = "CPI EU ACF")
```
```{r}
acf_values <- acf(data_ts$ireu, plot = FALSE) 
autoplot(acf_values, xlab = "Lag", ylab = "ACF", main = "IR EU ACF")
```


```{r}
ggtsdisplay(data_ts$cpieu, lag = 48)
```

```{r}
stl_result <- stl(ts(data_ts$cpieu, frequency = 12), s.window = 44)
plot(stl_result)
```

```{r}
ggtsdisplay(data_ts$ireu, lag = 48)
```


```{r}
stl_result <- stl(ts(data_ts$ireu, frequency = 12), s.window = 44)
plot(stl_result)
```



```{r}
total_obs <- nrow(data_ts)
test_obs <- 3

train_data <- head(data_ts, total_obs - test_obs)
test_data <- tail(data_ts, test_obs)

head(train_data)
head(test_data)
```
LINEAR MODEL, CPI
```{r}
linear_model <- train_data %>%
  model(linear = TSLM(cpieu ~ trend()))
      
report(linear_model)
```

```{r}
linear_model %>% gg_tsresiduals()
```

```{r}
fc_linear <- linear_model %>% forecast(h = 3)
residuals_linear <- linear_model %>% residuals()
```

```{r}
errors_linear <- accuracy(fc_linear, test_data)
errors_linear
```

```{r}
fc_linear %>%
  autoplot(bind_rows(train_data, test_data), level=80)+
  geom_line(data = fitted(linear_model),
            aes(y = .fitted, colour = .model)) +
  labs(y = "CPI EU",
       title = "CPI EU forecast, Linear Regression")
```


NONLINEAR REGRESSION, CPI
```{r}
nonlinear_model <- train_data %>%
  model(nonlinear = nls(cpieu ~ a * sin(b * YearMonth) + c, start = list(a = 1, b = 1, c = 1)))

report(nonlinear_model)
```

```{r}
linear_model <- train_data %>%
  model(linear = TSLM(cpieu ~ trend()))
      
report(linear_model)
```

```{r}
linear_model %>% gg_tsresiduals()
```

```{r}
fc_linear <- linear_model %>% forecast(h = 3)
residuals_linear <- linear_model %>% residuals()
```

```{r}
errors_linear <- accuracy(fc_linear, test_data)
errors_linear
```

```{r}
fc_linear %>%
  autoplot(bind_rows(train_data, test_data), level=80)+
  geom_line(data = fitted(linear_model),
            aes(y = .fitted, colour = .model)) +
  labs(y = "CPI EU",
       title = "CPI EU forecast")
```
????????????????????????????

GRADIENT BOOSTING, CPI

# Gradient Boosting (xgboost)
library(xgboost)

# Convert train_data to a matrix for xgboost
train_matrix <- xgb.DMatrix(as.matrix(train_data$cpieu))

# Train the xgboost model
boost_model <- xgboost(data = train_matrix, label = train_data$cpieu, nrounds = 10)

# Forecasting with the xgboost model
fc_boost <- predict(boost_model, newdata = as.matrix(train_data$cpieu), ntreelimit = 10)


```{r}
train_matrix <- xgb.DMatrix(as.matrix(train_data$cpieu))
boost_model <- xgboost(data = train_matrix, label = train_data$cpieu, nrounds = 10)

```
```{r}
linear_model <- train_data %>%
  model(linear = TSLM(cpieu ~ trend()))
      
report(linear_model)
```

```{r}
linear_model %>% gg_tsresiduals()
```

```{r}
fc_linear <- linear_model %>% forecast(h = 3)
residuals_linear <- linear_model %>% residuals()
```

```{r}
errors_linear <- accuracy(fc_linear, test_data)
errors_linear
```

```{r}
fc_linear %>%
  autoplot(bind_rows(train_data, test_data), level=80)+
  geom_line(data = fitted(linear_model),
            aes(y = .fitted, colour = .model)) +
  labs(y = "CPI EU",
       title = "CPI EU forecast")
```


```{r}
```

ARIMA, CPI
```{r}
arima_model <- train_data %>%
  model(arima = ARIMA(cpieu))
      
report(arima_model)
```

```{r}
arima_model %>% gg_tsresiduals()
```

```{r}
fc_arima <- arima_model %>% forecast(h = 3)
residuals_arima <- arima_model %>% residuals()
```

```{r}
errors_arima <- accuracy(fc_arima, test_data)
errors_arima
```

```{r}
fc_arima %>%
  autoplot(bind_rows(train_data, test_data), level=80)+
  geom_line(data = fitted(arima_model),
            aes(y = .fitted, colour = .model)) +
  labs(y = "CPI EU",
       title = "CPI EU forecast, ARIMA")
```


GENERALIZED ADDITIVE MODEL, CPI

```{r}
train_data$numeric_date <- as.numeric(train_data$YearMonth)
gam_model <- gam(cpieu ~ s(numeric_date), data = train_data)
fc_gam <- predict(gam_model, newdata = test_data) 
test_data$numeric_date <- as.numeric(test_data$YearMonth)
errors_gam <- accuracy(fc_gam, test_data)$error

```

```{r}
summary(gam_model)
```


```{r}
fc_gam <- predict(gam_model, newdata = train_data, type = "response", se.fit = TRUE)

residuals_linear <- linear_model %>% residuals()
```

```{r}
errors_linear <- accuracy(fc_linear, test_data)
errors_linear
```

```{r}
fc_linear %>%
  autoplot(bind_rows(train_data, test_data), level=80)+
  geom_line(data = fitted(linear_model),
            aes(y = .fitted, colour = .model)) +
  labs(y = "CPI EU",
       title = "CPI EU forecast")
```



```{r}
fit_trends <- train_data %>%
  model(
    arima = ARIMA(cpieu),
    holt_winter = HoltWinters(train_data$cpieu, seasonal = "multiplicative", seasonal.periods = 12)
  )

report(fit_trends)

fc_trends <- fit_trends %>% forecast(h = 3)


train_data %>%
  autoplot(cpieu) +
  geom_line(data = fitted(fit_trends),
            aes(y = .fitted, colour = .model)) +
  autolayer(fc_trends$arima, alpha = 0.5, level = 95) +
  autolayer(fc_trends$holt_winter, alpha = 0.5, level = 95) +
  labs(y = "CPI EU",
       title = "CPI EU: ARIMA, HOLT-WINTER")
```

IR


LINEAR MODEL, IR
```{r}
linear_model <- train_data %>%
  model(linear = TSLM(ireu ~ trend()))
      
report(linear_model)
```

```{r}
linear_model %>% gg_tsresiduals()
```

```{r}
fc_linear <- linear_model %>% forecast(h = 3)
residuals_linear <- linear_model %>% residuals()
```

```{r}
errors_linear <- accuracy(fc_linear, test_data)
errors_linear
```

```{r}
fc_linear %>%
  autoplot(bind_rows(train_data, test_data), level=80)+
  geom_line(data = fitted(linear_model),
            aes(y = .fitted, colour = .model)) +
  labs(y = "IR EU",
       title = "IR EU forecast, Linear Regression")
```

```{r}
```

ARIMA, IR

```{r}
arima_model <- train_data %>%
  model(arima = ARIMA(ireu))
      
report(arima_model)
```


```{r}
arima_model %>% gg_tsresiduals()
```

```{r}
fc_arima <- arima_model %>% forecast(h = 3)
residuals_arima <- arima_model %>% residuals()
```

```{r}
errors_arima <- accuracy(fc_arima, test_data)
errors_arima
```


```{r}
fc_arima %>%
  autoplot(bind_rows(train_data, test_data), level=80)+
  geom_line(data = fitted(arima_model),
            aes(y = .fitted, colour = .model)) +
  labs(y = "CPI EU",
       title = "IR EU forecast, ARIMA")
```

```{r}
```


```{r}
```


```{r}
model_arima <- train_tsibble %>%
  model(ARIMA(ireu))

model_ets <- train_tsibble %>%
  model(ETS(ireu))
```

```{r}

```


```{r}
```


```{r}
```

